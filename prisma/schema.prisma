// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- MEVCUT COMPARE TABLOLARI ---
model Brand {
  id    String @id @default(cuid())
  name  String @unique
  cars  Car[]
}

model Car {
  id          String         @id @default(cuid())
  modelName   String
  year        Int
  imageUrl    String?
  brandId     String
  createdAt   DateTime       @default(now())
  originalId  String?
  brand       Brand          @relation(fields: [brandId], references: [id])
  features    SecurityFeature[]
  specs       TechnicalSpecs?
}

model TechnicalSpecs {
  id              String  @id @default(cuid())
  carId           String  @unique
  horsepower      Int?
  torque          Int?
  acceleration    Float?
  topSpeed        Int?
  fuelConsumption Float?
  driveTrain      String?
  batteryType     String?
  chargingTime    String?
  electricRange   Int?
  engineVolume    Float?
  length          Int?
  luggageCapacity Int?
  weight          Int?
  width           Int?
  car             Car     @relation(fields: [carId], references: [id], onDelete: Cascade)
}

model SecurityFeature {
  id          String  @id @default(cuid())
  name        String
  isAvailable Boolean
  carId       String
  car         Car     @relation(fields: [carId], references: [id], onDelete: Cascade)
}

// --- YENİ: ASSISTANT SAYFASI İÇİN ÖZEL TABLO ---
model AssistantCar {
  id          String   @id @default(cuid())
  originalId  String   @unique // JSON'daki ID

  // Temel Bilgiler
  brand       String
  model       String
  trim        String?
  year        Int
  body        String   // SUV, Sedan
  fuel        String   // Elektrik
  drivetrain  String   // FWD
  transmission String  // Tek oranlı
  price       Int      
  
  // Filtreleme Alanları
  tags        String[] // ["Şehir içi", "Aile Odaklı"]

  // Görseller
  imageMain     String?
  imageInterior String?
  brandLogo     String?

  // Puanlar
  scoreTotal       Int?
  scoreEconomy     Int?
  scoreComfort     Int?
  scoreSafety      Int?
  scorePerformance Int?
  scoreTechnology  Int?

  // Neden Bu Araç?
  whyText     String?  @db.Text
  whyBullets  String[]

  // Detaylar (JSON olarak)
  specs       Json?    
  
  createdAt   DateTime @default(now())
}

// --- KULLANICI OTURUMU VE SEÇİMLERİ ---
model UserSession {
  id            String   @id @default(cuid())
  
  // Kullanıcı seçimleri
  usageTags     String[] // ["Şehir içi", "Uzun yol"]
  bodyType      String?  // "SUV"
  fuelType      String?  // "Elektrikli"
  priorityTags  String[] // ["Güvenlik", "Düşük tüketim"]
  budget        Int?     // 2000000
  
  // Seçim geçmişi (her adımı JSON olarak saklayabiliriz)
  selectionHistory Json?  // Tüm seçim adımlarının kaydı
  
  // Önerilen araçlar
  recommendedCarIds String[] // Önerilen araç ID'leri
  selectedCarId     String?  // Kullanıcının seçtiği araç ID'si
  
  // Oturum bilgileri
  deviceFingerprint String?  // Tarayıcı parmak izi (opsiyonel)
  ipAddress         String?  // IP adresi (opsiyonel)
  userAgent         String?  // Tarayıcı bilgisi
  
  // Zaman damgaları
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  completedAt  DateTime? // Öneri alındığında
}

// --- AI CHAT LOGLARI ---
model ChatSession {
  id            String   @id @default(cuid())
  
  // Kullanıcı ilişkisi (opsiyonel - giriş yapmamış kullanıcılar için null)
  userId        String?
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Oturum bilgileri
  sessionToken  String?  // Tarayıcı oturumu için
  ipAddress     String?
  userAgent     String?
  
  // Ayarlar
  persona       String?  // AI Persona seçimi
  budgetFlex    String?  // Bütçe esnekliği
  priorityWeight String? // Öncelik ağırlığı
  theme         String?  // Tema seçimi
  
  // İlişkiler
  messages      ChatMessage[]
  
  // Zaman damgaları
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ChatMessage {
  id            String   @id @default(cuid())
  
  // Mesaj içeriği
  role          String   // "user" veya "assistant"
  content       String   @db.Text
  
  // İlişki
  sessionId     String
  session       ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Meta bilgiler
  tokenCount    Int?     // Kullanılan token sayısı (opsiyonel)
  responseTime  Int?     // Yanıt süresi (ms)
  
  // Zaman damgası
  createdAt     DateTime @default(now())
}

// --- KULLANICI YÖNETİMİ ---
model User {
  id            String   @id @default(cuid())
  
  // Temel bilgiler
  email         String   @unique
  password      String   // bcrypt hash
  name          String?
  
  // Profil
  avatar        String?
  
  // Hesap durumu
  isVerified    Boolean  @default(false)
  isActive      Boolean  @default(true)
  
  // Oturum bilgileri
  lastLoginAt   DateTime?
  lastLoginIp   String?
  
  // İlişkiler
  sessions      AuthSession[]
  aiSettings    UserAISettings?
  vehiclePrefs  UserVehiclePreferences?
  chatSessions  ChatSession[]
  matchedCars   UserMatchedCar[]
  
  // Zaman damgaları
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// --- KULLANICI MATCH ARAÇLARI ---
model UserMatchedCar {
  id            String   @id @default(cuid())
  
  // Kullanıcı ilişkisi
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Araç bilgileri (AssistantCar'dan kopyalanır)
  carId         String   // AssistantCar originalId
  brand         String
  model         String
  trim          String?
  year          Int
  body          String
  fuel          String
  price         Int
  imageMain     String?
  brandLogo     String?
  
  // Match bilgileri
  matchScore    Int?     // Eşleşme skoru
  matchDate     DateTime @default(now())
  
  // Notlar (kullanıcı ekleyebilir)
  notes         String?
  isFavorite    Boolean  @default(false)
  
  // Unique constraint - aynı kullanıcı aynı arabayı birden fazla kez ekleyemez
  @@unique([userId, carId])
}

model AuthSession {
  id            String   @id @default(cuid())
  
  // Token
  token         String   @unique
  
  // Kullanıcı ilişkisi
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Cihaz bilgileri
  userAgent     String?
  ipAddress     String?
  
  // Geçerlilik
  expiresAt     DateTime
  
  // Zaman damgası
  createdAt     DateTime @default(now())
}

// --- AI ASSISTANT AYARLARI ---
model UserAISettings {
  id                    String   @id @default(cuid())
  
  // Kullanıcı ilişkisi
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Customization
  customizationEnabled  Boolean  @default(true)
  customInstructions    String?  @db.Text
  
  // Response Settings
  responseStyle         String   @default("Dengeli")   // Kısa, Dengeli, Detaylı
  tone                  String   @default("Samimi")    // Teknik, Kurumsal, Samimi
  
  // Suggestion Settings
  suggestionSensitivity String   @default("Orta")      // Sıkı, Orta, Geniş
  budgetFlexibility     String   @default("+10%")      // +5%, +10%, +20%
  brandPreference       String   @default("Dengeli")   // Dengeli, Favori
  
  // UI Settings
  typingAnimation       Boolean  @default(true)
  useHistory            Boolean  @default(true)
  
  // Zaman damgaları
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// --- ARAÇ TERCİHLERİ ---
model UserVehiclePreferences {
  id                    String   @id @default(cuid())
  
  // Kullanıcı ilişkisi
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Kullanım tercihleri
  usage                 String[] // ["Şehir içi", "Uzun yol", "Karma"]
  bodyType              String[] // ["SUV", "Sedan", "Hatchback"]
  fuelType              String[] // ["Elektrikli", "Hibrit", "Benzin"]
  priorities            String[] // ["Güvenlik", "Düşük tüketim", "Performans"]
  
  // Favori markalar (%90 ağırlık)
  brands                String[] // ["BMW", "Mercedes-Benz", "Audi"]
  
  // Zaman damgaları
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// --- BÜLTEN ABONELİĞİ ---
model NewsletterSubscriber {
  id            String   @id @default(cuid())
  
  // E-posta adresi
  email         String   @unique
  
  // Abonelik durumu
  isActive      Boolean  @default(true)
  
  // Zaman damgaları
  subscribedAt  DateTime @default(now())
  unsubscribedAt DateTime?
}